(function(){var a=[];window.addEventListener("message",function(b){b.source==window&&"zero-timeout-message"==b.data&&(b.stopPropagation(),0<a.length&&a.shift()())},!0);window.setZeroTimeout=function(b){a.push(b);window.postMessage("zero-timeout-message","*")}})();
var QLearn=function(){this.logs={};this.rewardTable={};this.transitionMatrix={};this.learningRate=0.1;this.display=this.use=!1;this.addState=function(a,b,c,d){this.rewardTable[d]=c;void 0==this.logs[a+"->"+b+"->"+d]&&(this.logs[a+"->"+b+"->"+d]=c);void 0==this.transitionMatrix[a]&&(this.transitionMatrix[a]={});c=0;for(var e in this.transitionMatrix[d])this.transitionMatrix[d][e]>c&&(c=this.transitionMatrix[d][e]);this.transitionMatrix[a][b]=this.rewardTable[d]+this.learningRate*c};this.getBestPolicy=
function(a){a=this.transitionMatrix[a];var b="undefined",c=-99999999,d;for(d in a){var e=a[d];e>=c&&e!=c&&(c=e,b=d)}this.display&&console.log(b);return b};this.getTransitionMatrix=function(){return this.transitionMatrix};this.converge=function(){for(var a=JSON.stringify(this.getTransitionMatrix());;){for(var b in this.logs){var c=this.logs[b],d=b.split("->");this.addState(d[0],d[1],c,d[2])}if(a!=JSON.stringify(this.getTransitionMatrix()))a=JSON.stringify(this.getTransitionMatrix());else{this.use=
!0;break}}}},Qgame=new QLearn,game,FPS=60,maxScore=0,images={},di=0,speed=function(a){FPS=parseInt(a)},loadImages=function(a,b){var c=0,d=0,e={},f;for(f in a)c++,e[f]=new Image,e[f].src=a[f],e[f].onload=function(){d++;d==c&&b(e)}},Bird=function(a){this.x=80;this.y=250;this.width=40;this.height=30;this.alive=!0;this.gravity=0;this.velocity=0.3;this.jump=-6;this.init(a)};Bird.prototype.init=function(a){for(var b in a)this[b]=a[b]};Bird.prototype.flap=function(){this.gravity=this.jump};
Bird.prototype.update=function(){this.gravity+=this.velocity;this.y+=this.gravity};Bird.prototype.isDead=function(a,b){if(this.y>=a||0>=this.y+this.height)return!0;for(var c in b)if(!(this.x>b[c].x+b[c].width||this.x+this.width<b[c].x||this.y>b[c].y+b[c].height||this.y+this.height<b[c].y))return!0};var Pipe=function(a){this.y=this.x=0;this.width=50;this.height=40;this.speed=3;this.init(a)};Pipe.prototype.init=function(a){for(var b in a)this[b]=a[b]};Pipe.prototype.update=function(){this.x-=this.speed};
Pipe.prototype.isOut=function(){if(0>this.x+this.width)return!0};var Game=function(){this.pipes=[];this.birds=[];this.score=0;this.canvas=document.querySelector("#flappy");this.ctx=this.canvas.getContext("2d");this.width=this.canvas.width;this.height=this.canvas.height;this.spawnInterval=90;this.interval=0;this.gen=[];this.generation=this.alives=0;this.backgroundSpeed=0.5;this.maxScore=this.backgroundx=0};
Game.prototype.start=function(){this.score=this.interval=0;this.pipes=[];this.birds=[];for(var a=99;0<=a;a--){var b=new Bird;this.birds.push(b)}this.generation++;this.alives=this.birds.length};
Game.prototype.update=function(){this.backgroundx+=this.backgroundSpeed;var a=0;if(0<this.birds.length)for(var b=0;b<this.pipes.length;b+=2)if(this.pipes[b].x+this.pipes[b].width>this.birds[0].x){a=this.pipes[b].height/this.height;break}for(b in this.birds)if(this.birds[b].alive){var c=[Math.floor(this.birds[b].y/this.height*100)/100,Math.floor(100*a)/100];Qgame.use?(c=Qgame.getBestPolicy(""+(c[1]-c[0])),"true"==c&&this.birds[di].flap()):(c=0,0.5<c&&this.birds[b].flap());this.birds[b].update();this.birds[b].isDead(this.height,
this.pipes)&&(this.birds[b].alive=!1,this.alives--,this.isItEnd()&&this.start())}for(b=0;b<this.pipes.length;b++)this.pipes[b].update(),this.pipes[b].isOut()&&(this.score++,this.pipes.splice(b,1),b--);0==this.interval&&(a=Math.round(Math.random()*(this.height-100-120))+50,this.pipes.push(new Pipe({x:this.width,y:0,height:a})),this.pipes.push(new Pipe({x:this.width,y:a+120,height:this.height})));this.interval++;this.interval==this.spawnInterval&&(this.interval=0);this.maxScore=this.score>this.maxScore?
this.score:this.maxScore;var d=this;0==FPS?setZeroTimeout(function(){d.update()}):setTimeout(function(){d.update()},1E3/FPS)};Game.prototype.isItEnd=function(){for(var a in this.birds)if(this.birds[a].alive)return!1;return!0};
Game.prototype.display=function(){this.ctx.clearRect(0,0,this.width,this.height);for(var a=0;a<Math.ceil(this.width/images.background.width)+1;a++)this.ctx.drawImage(images.background,a*images.background.width-Math.floor(this.backgroundx%images.background.width),0);for(a in this.pipes)0==a%2?this.ctx.drawImage(images.pipetop,this.pipes[a].x,this.pipes[a].y+this.pipes[a].height-images.pipetop.height,this.pipes[a].width,images.pipetop.height):this.ctx.drawImage(images.pipebottom,this.pipes[a].x,this.pipes[a].y,
this.pipes[a].width,images.pipetop.height);this.ctx.fillStyle="#FFC600";this.ctx.strokeStyle="#CE9E00";for(a in this.birds)this.birds[a].alive&&(this.ctx.save(),this.ctx.translate(this.birds[a].x+this.birds[a].width/2,this.birds[a].y+this.birds[a].height/2),this.ctx.rotate(Math.PI/2*this.birds[a].gravity/20),this.ctx.drawImage(images.bird,-this.birds[a].width/2,-this.birds[a].height/2,this.birds[a].width,this.birds[a].height),this.ctx.restore());this.ctx.fillStyle="white";this.ctx.font="20px Oswald, sans-serif";
this.ctx.fillText("Score : "+this.score,10,25);this.ctx.fillText("Max Score : "+this.maxScore,10,50);this.ctx.fillText("Generation : "+this.generation,10,75);this.ctx.fillText("Alive : "+this.alives+" / 100",10,100);var b=this;requestAnimationFrame(function(){b.display()})};window.onload=function(){loadImages({bird:"./img/bird.png",background:"./img/background.png",pipetop:"./img/pipetop.png",pipebottom:"./img/pipebottom.png"},function(a){images=a;game=new Game;game.start();game.update();game.display()})};
var UseTransitionMatrixToCompute=function(){Qgame.converge();console.log("rough size:",JSON.stringify(Qgame.transitionMatrix).length)};$.get("./assets/logs.json",function(a){logs=a;a=[];for(var b in logs){var c=logs[b],d=b.split("->");a.push([d[0],d[1],c,d[2]].join(" "))}Qgame.logs=logs;$("#inputs").val(a.join("\n"))});
